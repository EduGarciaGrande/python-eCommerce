{% load static %}
<!DOCTYPE html>
    <html lang="en">
    <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <title>Base template</title>
        {% include "base/css.html" %}
        {% block base_head %}{% endblock %}
    </head>
    <body>
        {% include "base/navbar.html" with brand_name='eCommerce' %}
        <div class="container">
            {% block content %}{% endblock %}
        </div>
        {% include "base/js.html" %}

        <script>
            $(document).ready(function () {
                var productForm = $(".form-product-ajax");

                // Submitting form is not allowed
                productForm.submit(function (event) {
                    event.preventDefault();

                    var thisForm = $(this), actionEndpoint = thisForm.attr("action"),
                        httpMethod = thisForm.attr("method"),
                        formData = thisForm.serialize();

                    $.ajax({
                        url: actionEndpoint,
                        method: httpMethod,
                        data: formData,
                        success: function (data) {
                            var submitSpan = thisForm.find(".submit-span"),
                                navbarCount = $(".navbar-cart-count");

                            navbarCount.text(data.cartItemCount);

                            if(data.added){
                                submitSpan.html("In cart <button type=\"submit\" class=\"btn btn-link\">Remove ?</button>");
                            } else {
                                submitSpan.html("<button type=\"submit\" class=\"btn btn-success\">Add to cart</button>");
                            }

                            var currentPath = window.location.href;
                            if(currentPath.indexOf("cart") != -1){
                                refreshCart();
                            }
                        },
                        error: function (errorData) {
                            console.log("error");
                            console.log(errorData);
                        }
                    })
                });
                
                function refreshCart() {
                    var cartTable = $(".cart-table"), cartBody = cartTable.find(".cart-body"),
                        productRows = cartBody.find(".cart-product"),
                        currentUrl = window.location.href;

                    var refreshCartUrl = '/api/cart/', refreshCartMethod = "GET", data = {};
                    $.ajax({
                        url: refreshCartUrl,
                        method: refreshCartMethod,
                        data: data,
                        success: function(data){
                            console.log("success");
                            console.log(data);

                            if (data.products.length > 0){
                                productRows.html(" ");

                                i = 1;
                                $.each(data.products, function (index, value) {
                                    cartBody.prepend("<tr><th scope=\"row\">" + i + "</th><td>" + value.name + "</td><td>" + value.price +  "</td></tr>");
                                    i++;
                                });

                                cartBody.find(".cart-subtotal").text(data.subtotal);
                                cartBody.find(".cart-total").text(data.total);
                            } else{
                                window.location.href = currentUrl;
                            }
                        },
                        error: function(errorData){
                            console.log("error");
                            console.log(errorData);
                        }
                    })
                }
            })
        </script>
    </body>
</html>