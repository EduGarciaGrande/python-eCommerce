{% load static %}
<!DOCTYPE html>
    <html lang="en">
    <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <title>Base template</title>
        {% include "base/css.html" %}
        {% block base_head %}{% endblock %}
    </head>
    <body>
        {% include "base/navbar.html" with brand_name='eCommerce' %}
        <div class="container">
            {% block content %}{% endblock %}
        </div>
        {% include "base/js.html" %}

        <script>
            $(document).ready(function () {

                // Auto Search
                var searchForm = $(".search-form"), searchInput = searchForm.find("[name='q']");
                var searchBtn = searchForm.find("[type='submit']"), typingTimer, typingInterval = 500;
                
                searchInput.keyup(function (event) {
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(performSearch, typingInterval);
                });

                searchInput.keydown(function (event) {
                    clearTimeout(typingTimer);
                });

                function displaySearching(){
                    searchBtn.addClass("disabled");
                    searchBtn.html('<i class="fa fa-spin fa-spinner"></i>Searching...');
                }
                
                function performSearch() {
                    displaySearching();
                    var query = searchInput.val();
                    setTimeout(function () {
                        window.location.href = '/search/?q=' + query;
                    }, 1000);
                }


                // Cart + Add products
                var productForm = $(".form-product-ajax");

                // Submitting form is not allowed
                productForm.submit(function (event) {
                    event.preventDefault();

                    var thisForm = $(this), actionEndpoint = thisForm.attr("action"),
                        httpMethod = thisForm.attr("method"),
                        formData = thisForm.serialize();

                    $.ajax({
                        url: actionEndpoint,
                        method: httpMethod,
                        data: formData,
                        success: function (data) {
                            var submitSpan = thisForm.find(".submit-span"),
                                navbarCount = $(".navbar-cart-count");

                            navbarCount.text(data.cartItemCount);

                            if(data.added){
                                submitSpan.html("In cart <button type=\"submit\" class=\"btn btn-link\">Remove ?</button>");
                            } else {
                                submitSpan.html("<button type=\"submit\" class=\"btn btn-success\">Add to cart</button>");
                            }

                            var currentPath = window.location.href;
                            if(currentPath.indexOf("cart") != -1){
                                refreshCart();
                            }
                        },
                        error: function (errorData) {
                            $.alert("An error occurred");
                            console.log("error");
                            console.log(errorData);
                        }
                    })
                });
                
                function refreshCart() {
                    var cartTable = $(".cart-table"), cartBody = cartTable.find(".cart-body"),
                        productRows = cartBody.find(".cart-product"),
                        currentUrl = window.location.href;

                    var refreshCartUrl = '/api/cart/', refreshCartMethod = "GET", data = {};
                    $.ajax({
                        url: refreshCartUrl,
                        method: refreshCartMethod,
                        data: data,
                        success: function(data){
                            var hiddenCartItemRemoveForm = $(".cart-item-remove-form");
                            if (data.products.length > 0){
                                productRows.html(" ");

                                i = data.products.length;
                                $.each(data.products, function (index, value) {
                                    var newCartItemRemove = hiddenCartItemRemoveForm.clone();
                                    newCartItemRemove.css("display", "block");
                                    newCartItemRemove.find(".cart-item-product-id").val(value.id);
                                    cartBody.prepend("<tr><th scope=\"row\">" + i + "</th><td><a href='" + value.url + "'>" +
                                        value.name + "</a>" + newCartItemRemove.html() + "</td><td>" + value.price +  "</td></tr>");
                                    i--;
                                });

                                cartBody.find(".cart-subtotal").text(data.subtotal);
                                cartBody.find(".cart-total").text(data.total);
                            } else{
                                window.location.href = currentUrl;
                            }
                        },
                        error: function(errorData){
                            console.log("error");
                            console.log(errorData);
                        }
                    })
                }
            })
        </script>
    </body>
</html>